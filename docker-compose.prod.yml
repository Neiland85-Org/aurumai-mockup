version: "3.9"

# =============================================================================
# PRODUCTION DOCKER COMPOSE CONFIGURATION
# =============================================================================
# This file is optimized for production deployment with:
# - Resource limits (memory, CPU)
# - Comprehensive healthchecks
# - Security hardening (read-only root filesystem where possible)
# - Restart policies
# - Logging configuration
#
# REQUIREMENTS:
#   1. Create .env file with production secrets (use .env.example as template)
#   2. Build production images first:
#      docker-compose -f docker-compose.prod.yml build
#   3. Deploy:
#      docker-compose -f docker-compose.prod.yml up -d
#
# SECURITY NOTICE:
# - NEVER commit .env file to git
# - Use strong passwords (min 32 chars for SECRET_KEY, min 16 for DB)
# - Review resource limits based on your infrastructure
# =============================================================================

services:
  # PostgreSQL with TimescaleDB extension for time-series data
  postgres:
    image: timescale/timescaledb:latest-pg15
    container_name: aurumai-postgres-prod
    env_file:
      - .env
    environment:
      - POSTGRES_DB=${DB_NAME:?DB_NAME is required}
      - POSTGRES_USER=${DB_USER:?DB_USER is required}
      - POSTGRES_PASSWORD=${DB_PASSWORD:?DB_PASSWORD is required}
      # Performance tuning
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    networks:
      - aurumai-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${DB_USER:-aurumai} -d ${DB_NAME:-aurumai}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: always
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Security
    security_opt:
      - no-new-privileges:true
    # Run postgres with reduced privileges (already runs as postgres user)
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID

  # FastAPI Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    image: aurumai-backend:${VERSION:-latest}
    container_name: aurumai-backend-prod
    env_file:
      - .env
    environment:
      # Database connection
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=${DB_USER:?DB_USER is required}
      - DB_PASSWORD=${DB_PASSWORD:?DB_PASSWORD is required}
      - DB_NAME=${DB_NAME:?DB_NAME is required}
      # TimescaleDB (same credentials)
      - TSDB_HOST=postgres
      - TSDB_PORT=5432
      - TSDB_USER=${DB_USER:?DB_USER is required}
      - TSDB_PASSWORD=${DB_PASSWORD:?DB_PASSWORD is required}
      - TSDB_NAME=${DB_NAME:?DB_NAME is required}
      # Security
      - SECRET_KEY=${SECRET_KEY:?SECRET_KEY is required}
      - ENVIRONMENT=production
      - DEBUG=false
      # API
      - API_HOST=0.0.0.0
      - API_PORT=${API_PORT:-8000}
      # CORS (production origins)
      - CORS_ORIGINS=${CORS_ORIGINS:?CORS_ORIGINS is required}
    volumes:
      - backend-data:/data
    ports:
      - "${API_PORT:-8000}:8000"
    networks:
      - aurumai-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 40s
    restart: always
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    # Security
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    # Read-only root filesystem (excluding writable volumes)
    # Commented out as backend may need to write temporary files
    # read_only: true
    tmpfs:
      - /tmp

  # Edge Simulator
  edge-sim:
    build:
      context: ./edge-sim
      dockerfile: Dockerfile
    image: aurumai-edge-sim:${VERSION:-latest}
    container_name: aurumai-edge-prod
    env_file:
      - .env
    environment:
      - EDGE_PORT=9000
      - BACKEND_HOST=backend
      - BACKEND_PORT=${API_PORT:-8000}
      - SYNC_INTERVAL=${EDGE_SYNC_INTERVAL:-5}
      - BACKEND_API_URL=http://backend:${API_PORT:-8000}
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "${EDGE_PORT:-9000}:9000"
    networks:
      - aurumai-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: always
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Security
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    tmpfs:
      - /tmp

  # IoT Simulator
  iot-sim:
    build:
      context: ./iot-sim
      dockerfile: Dockerfile
    image: aurumai-iot-sim:${VERSION:-latest}
    container_name: aurumai-iot-prod
    env_file:
      - .env
    environment:
      - EDGE_HOST=edge-sim
      - EDGE_PORT=${EDGE_PORT:-9000}
      - BACKEND_API_URL=http://backend:${API_PORT:-8000}
      - MACHINES=${MACHINES:-TRUCK-21,MILL-3,BOILER-7}
      - SIM_INTERVAL_SECONDS=${SIM_INTERVAL_SECONDS:-3}
      - NORMAL_PHASE_CYCLES=${NORMAL_PHASE_CYCLES:-50}
      - DRIFT_PHASE_CYCLES=${DRIFT_PHASE_CYCLES:-50}
      - IOT_BATCH_SIZE=${IOT_BATCH_SIZE:-100}
      - IOT_BATCH_INTERVAL=${IOT_BATCH_INTERVAL:-5}
    depends_on:
      edge-sim:
        condition: service_healthy
    networks:
      - aurumai-network
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep '[p]ython' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: always
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Security
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp

  # Next.js Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    image: aurumai-frontend:${VERSION:-latest}
    container_name: aurumai-frontend-prod
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:?NEXT_PUBLIC_API_URL is required}
      - NEXT_PUBLIC_API_BASE=${NEXT_PUBLIC_API_BASE:?NEXT_PUBLIC_API_BASE is required}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - aurumai-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1",
        ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: always
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    # Security
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    # Read-only root filesystem
    read_only: true
    tmpfs:
      - /tmp
      - /.next/cache

volumes:
  postgres-data:
    driver: local
    driver_opts:
      type: none
      device: ${POSTGRES_DATA_PATH:-./data/postgres}
      o: bind
  backend-data:
    driver: local
    driver_opts:
      type: none
      device: ${BACKEND_DATA_PATH:-./data/backend}
      o: bind

networks:
  aurumai-network:
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-172.28.0.0/16}
